<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link rel="stylesheet" href="../lib/style-tools.css" />
    <link rel="stylesheet" href="../lib/themes/emerson-theme.css" />
    <script type="module" src="../lib/chat-modal/chat-modal.js"></script>
    <script type="module" src="../lib/app-modal/app-modal.js"></script>

    <script type="module" src="../lib/ask-ai/ask-llm.js"></script>
    <script type="module" src="../lib/http-request/http-request.js"></script>
    <script type="module" src="../lib/ui-data/ui-data-repeat.js"></script>
    <script type="module" src="../lib/ask-ai/ask-llm.js"></script>

    <link rel="stylesheet" href="../lib/css/index.css" />
    <link rel="stylesheet" href="../lib/css/themes/default-theme.css" />

    <style>
      app-modal * {
        box-sizing: border-box;
      }

      /* Chat body */

      section.chat__body {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;

        padding: 0.5rem;
        border-radius: 0.4rem;

        min-height: 240px;
        max-height: 240px;

        overflow-x: auto;

        background-color: var(--background-color-2);
      }

      .chat__message-box {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;

        /* width: 80%; */
        max-width: 90%;

        padding: 0.5rem;
        border-radius: 0.4rem;

        font-size: 0.8rem;

        word-wrap: break-word;

        background-color: var(--background-color-6);
      }

      .chat__message-box.sender {
        align-self: flex-end;
        border-radius: 0.2rem 0.2rem 0 0.2rem;
      }

      .chat__message-box.receiver {
        border-radius: 0.2rem 0.2rem 0.2rem 0;
        background-color: var(--main-color-2);
      }

      .message-box__title {
        line-height: 1;
        font-size: 0.8rem;
        margin: 0;

        color: var(--text-color-emphasis-mid);
      }

      .sender .message-box__title {
        text-align: end;
      }

      .message-box__text {
        color: var(--text-color-emphasis-low);
      }

      /* Input */

      .footer {
        display: flex;
        align-items: center;
        gap: 0.5rem;

        min-width: 100%;
      }

      .chat__input-prompt {
        width: 80%;

        padding: 0.4rem;
        border-radius: 0.4rem;
        border: 1px solid var(--background-color-7);

        color: var(--text-color-emphasis-mid);

        background-color: var(--background-color-4);
      }

      .chat__input-prompt:focus {
        outline: none;
        filter: brightness(1.05);
      }

      .chat__send-btn {
        display: grid;
        place-items: center;
        width: 20%;
      }
    </style>
  </head>

  <body>
    <!-- <http-request id="post-to-llm" method="post" trigger="#ask-llm" on="prompt"
    url="https://cjyb64boo0.execute-api.us-east-2.amazonaws.com/dev/ask-llm" target="chat__body" append>
    <template>
      <p name="response"></p>
    </template>
  </http-request> -->

    <!-- <p>Here some instructions on how to emit events and how to emit events</p> -->
    <article id="instructions" style="display: none"></article>

    <event-source id="ask"></event-source>

    <!-- <app-modal trigger="#ask" on="data"></app-modal> -->

    <app-modal trigger="button" on="click">
      <!-- Title -->
      <span slot="title">Bedrock Chat</span>
      <!-- Body, where the messages would go -->

      <ask-llm id="ask-llm" trigger="#ask" on="data">
        <source src="#instructions" />
        <section class="chat__body"></section>
      </ask-llm>

      <div class="footer" slot="footer">
        <input
          id="prompt"
          class="chat__input-prompt"
          type="text"
          name="prompt"
          id="prompt"
        />
        <button id="send-message-btn" class="chat__send-btn">Send</button>
      </div>
    </app-modal>
    <button>Press Me</button>

    <ui-data-repeat trigger="#ask-llm" on="add-to-cart" append>
      <template>
        <p name="name"></p>
      </template>
    </ui-data-repeat>
  </body>

  <!-- CÃ³digo de prueba -->
  <script>
    const chatBody = document.querySelector('.chat__body')
    const input = document.querySelector('.chat__input-prompt')
    const sendBtn = document.querySelector('.chat__send-btn')

    const eventSource = document.querySelector('#ask')

    console.log('source', eventSource)

    const instructions = `

    Your are running on a web environment, and you can emit events on the DOM by using a the 'emit-event' tag.
    Use the name attribute from the tag to give the event name, and use the data attributes for the values.

    <example>


      H: can you emit a test event.

      A: <emit-event name="test" data-property="some value" data-other-property="other value"></emit-event>
    

    </example>

    <example> 


      H:  emit an event 'add-to-cart', the name is DX30 graphics card, the value is $300 and the id is 3 

      A: <emit-event name="add-to-cart" data-name="DX30 graphics card" data-value="$300" data-id="3"></emit-event>


    </example>

  `

    const createMessageBox = (str, name) => {
      const messageBox = document.createElement('span')
      messageBox.className = 'chat__message-box sender'
      const content = `
				<h3 class="message-box__title">${name}</h3>
				<span class="message-box__text">
					${str}
				</span>`
      messageBox.innerHTML = content
      return messageBox
    }

    sendBtn.addEventListener('click', () => {
      const text = input.value
      if (text === '') return
      const messageBox = createMessageBox(text, 'Human')
      chatBody.appendChild(messageBox)
      messageBox.scrollIntoView({ behavior: 'smooth', block: 'start' })
      input.value = ''

      // eventSource.dispatchEvent(new CustomEvent('data', { detail: { prompt: text }, bubbles: true }))

      const prompt = Array.from(chatBody.querySelectorAll('.chat__message-box'))
        .map(box => {
          const text = box.querySelector('.message-box__text').textContent
          const sender = box.querySelector('.message-box__title').textContent
          return `${sender}: ${text}`
        })
        .join('\n\n')

      const api =
        'https://cjyb64boo0.execute-api.us-east-2.amazonaws.com/dev/ask-llm'

      const eventInstructions = `Human: Your are running on a web environment, and you can emit events on the DOM by using a the 'emit-event' tag.
    Use the name attribute from the tag to give the event name, and use the data attributes for the values.

    <example>


      H: can you emit a test event.

      A: <emit-event name="test" data-property="some value" data-other-property="other value"></emit-event>
    </example>

    ${renderHtmlInstructions}


    ${kanbanBoardInstructions}


    `
      fetch(api, {
        method: 'post',
        body: JSON.stringify({ prompt: eventInstructions + prompt })
      })
        .then(res => res.json())
        .then(res => {
          console.log(res)
          const response = createMessageBox(res.response, 'Assistant')
          response.className = 'chat__message-box receiver'
          chatBody.appendChild(response)
          response.scrollIntoView({ behavior: 'smooth', block: 'start' })
        })
        .catch(console.error)
    })
  </script>
</html>
